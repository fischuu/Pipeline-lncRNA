---
title: "Within species analysis"
subtitle: ""
author: "lncRNA group"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float:
      toc_collapsed: true
    number_sections: false
    theme: lumen
    df_print: paged
    code_folding: show
---
      
# Set the Project specific parameters
```{r setup, include=FALSE}
library("knitr")
library("GenomicTools")
library("fastqcr")
library("factoextra")
library("Rtsne")
library("ggplot2")
options(scipen=999)
knitr::opts_chunk$set(echo = FALSE,
                      cache = TRUE,
                      cache.lazy = FALSE,
                      dev = c('png', 'pdf'),
                      fig.align = 'center', fig.height = 5, fig.width = 8.5)

bosFolder <- "/media/ejo138/Fantec6/Projects/FAANG-lncRNA/bos_taurus"
capraFolder <- "/media/ejo138/Fantec6/Projects/FAANG-lncRNA/"
equusFolder <- "/media/ejo138/Fantec6/Projects/FAANG-lncRNA/equus_caballus"
gallusFolder <- "/media/ejo138/Fantec6/Projects/FAANG-lncRNA/gallus_gallus"
ovisFolder <- "/media/ejo138/Fantec4/Projects/FAANG-lncRNA/ovis_aries"
susFolder <- "/media/ejo138/Fantec6/Projects/FAANG-lncRNA/sus_scrofa"
projFolder <- "/home/ejo138/gitPipelines/Pipeline-FAANG-lncRNA/"


bosSamples <- as.vector(as.matrix(read.table(file.path(bosFolder, "samples"), stringsAsFactors = FALSE)))
#capraSamples <- as.vector(as.matrix(read.table(file.path(bosFolder, "samples"), stringsAsFactors = FALSE)))
equusSamples <- as.vector(as.matrix(read.table(file.path(equusFolder, "samples"), stringsAsFactors = FALSE)))
gallusSamples <- as.vector(as.matrix(read.table(file.path(gallusFolder, "samples"), stringsAsFactors = FALSE)))
ovisSamples <- as.vector(as.matrix(read.table(file.path(bosFolder, "samples"), stringsAsFactors = FALSE)))
susSamples <- as.vector(as.matrix(read.table(file.path(susFolder, "samples"), stringsAsFactors = FALSE)))

species <- c("Bos T.", "Capra H.", "Equus C.", "Gallus G.", "Ovis A.", "Sus S.")
samples <- read.table(file.path(projFolder,"2019.04.02-SamplesList.tsv"), sep="\t", stringsAsFactors=FALSE)
samples[,2] <- tolower(samples[,2])
samples[,3] <- tolower(samples[,3])
```

Import the annotations

```{r}
bosLNC <- importGTF(file.path(bosFolder,"FEELnc", "codpot", "feelnc_bos_taurus.codpot.lncRNA.gtf"), level="exon")
bosLNCIDs <- unique(bosLNC$gene_id)

#capraLNC <- importGTF(file.path(capraFolder,"FEELnc", "codpot", "feelnc_capra_hircus.codpot.lncRNA.gtf"), level="exon")
#capraLNCIDs <- unique(capraLNC$gene_id)

equusLNC <- importGTF(file.path(equusFolder,"FEELnc", "codpot", "feelnc_equus_caballus.codpot.lncRNA.gtf"), level="exon")
equusLNCIDs <- unique(equusLNC$gene_id)

gallusLNC <- importGTF(file.path(gallusFolder,"FEELnc", "codpot", "feelnc_gallus_gallus.codpot.lncRNA.gtf"), level="exon")
gallusLNCIDs <- unique(gallusLNC$gene_id)

ovisLNC <- importGTF(file.path(ovisFolder,"FEELnc", "codpot", "feelnc_ovis_aries.codpot.lncRNA.gtf"), level="exon")
ovisLNCIDs <- unique(ovisLNC$gene_id)

susLNC <- importGTF(file.path(susFolder,"FEELnc", "codpot", "feelnc_sus_scrofa.codpot.lncRNA.gtf"), level="exon")
susLNCIDs <- unique(susLNC$gene_id)
```

# Basic statistics

## Quality checks with FastQC

First, we import the quality checks from FastQC

```{r importFastQCReports, echo=FALSE, message=FALSE, warning=FALSE}
# Import the raw quality information
importRawReads <- function(dir){
  qcRawFiles <- list.files(file.path(dir,"FASTQC"), recursive=TRUE, pattern="*.zip")
  rawReads <- 0
  for(i in 1:length(qcRawFiles)){
    tmp <- qc_read(file.path(dir,"FASTQC",qcRawFiles[i]))
    rawReads[i] <- as.numeric(tmp$basic_statistics$Value[4]) 
  }
  names(rawReads) <- sapply(strsplit(sapply(strsplit(qcRawFiles,"/"),"[",2),"_f"),"[",1)
  
  rawReads[seq(2,length(rawReads),2)]
}

bosRawReads <- importRawReads(bosFolder)
#capraRawReads <- importRawReads(capraFolder)
equusRawReads <- importRawReads(equusFolder)
gallusRawReads <- importRawReads(gallusFolder)
ovisRawReads <- importRawReads(ovisFolder)
susRawReads <- importRawReads(susFolder)
```

## Number of raw reads

Visualize the raw reads

```{r boxplotR<awReads}
boxplot(bosRawReads, xlim=c(0.5,6.5), at=1)
#boxplot(capraRawReads, at=2, add=TRUE)
boxplot(equusRawReads, at=3, add=TRUE)
boxplot(gallusRawReads, at=4, add=TRUE)
boxplot(ovisRawReads, at=5, add=TRUE)
boxplot(susRawReads, at=6, add=TRUE)
axis(1, at=1:6, label=species)
```

## STAR mapping statistics

Import the STAR mapping statistics

```{r}
plotSTAR <- function(dir, main){
  starIn <- importSTARLog(file.path(dir, "BAM"))
  
  # Uniquely mapped reads
  boxplot(as.numeric(gsub("%","",as.vector(as.matrix(starIn$finalLog$uniqueReads[13,-1])))), xlim=c(0.5,3.5), at=1, ylim=c(0,100), main=main)
  
  boxplot(as.numeric(gsub("%","",as.vector(as.matrix(starIn$finalLog$multiMapping[1,-1])))), add=TRUE, at=2)
  boxplot(as.numeric(gsub("%","",as.vector(as.matrix(starIn$finalLog$unmappedReads[3,-1])))), add=TRUE, at=3)
  
  axis(1, at=c(1:3), labels=c("Uniq.", "Multim.", "Too short") ,las=2)
}

par(mfrow=c(2,3))
plotSTAR(bosFolder, "Bos taurus")
#plotSTAR(capraFolder, "Capra hircus")
plotSTAR(equusFolder, "Equus caballus")
plotSTAR(gallusFolder, "Gallus gallus")
plotSTAR(ovisFolder, "Ovis aries")
#plotSTAR(susFolder, "Sus scrofa")
```

## Feature Counts statistics statistics

Now some mapping and quantification statistics
```{r mappingStats}
# Import the featureCounts statistics
getFCSummary <- function(dir){
  fcFiles <- list.files(file.path(dir,"GTF", "Stringmerge_fc"), pattern="*.summary")
  fcSummary <- list()
  annotated <- c()
  unmapped <- c()
  unmapped.multi <- c()
  unmapped.ambi <- c()
  unannotated <- c()
  
  for(i in 1:length(fcFiles)){
    fcSummary[[i]] <- read.table(file.path(dir,"GTF", "Stringmerge_fc", fcFiles[i]), skip=1)
    annotated[i] <- fcSummary[[i]][1,2]
    unmapped[i] <- fcSummary[[i]][2,2]
    unmapped.multi <- fcSummary[[i]][7,2]
    unannotated[i] <- fcSummary[[i]][10,2]
    unmapped.ambi <- fcSummary[[i]][12,2]
  }
  
  out <- list(fcSummary, annotated, unmapped, unmapped.multi, unmapped.ambi, unannotated)
  out
}

bosMappingStats <- getFCSummary(bosFolder)
bosMappingStats.sum <- sapply(sapply(bosMappingStats[[1]],"[",2),sum)

#capraMappingStats <- getFCSummary(capraFolder)
#capraMappingStats.sum <- sapply(sapply(capraMappingStats[[1]],"[",2),sum)

equusMappingStats <- getFCSummary(equusFolder)
equusMappingStats.sum <- sapply(sapply(equusMappingStats[[1]],"[",2),sum)

#gallusMappingStats <- getFCSummary(gallusFolder)
#gallusMappingStats.sum <- sapply(sapply(gallusMappingStats[[1]],"[",2),sum)

#ovisMappingStats <- getFCSummary(ovisFolder)
#ovisMappingStats.sum <- sapply(sapply(ovisMappingStats[[1]],"[",2),sum)

susMappingStats <- getFCSummary(susFolder)
susMappingStats.sum <- sapply(sapply(susMappingStats[[1]],"[",2),sum)
```

And now visualize the percentages of the different mapping scenarios

```{r}
par(mfrow=c(2,3))
createBoxplots <- function(x1, x2, x3){
  boxplot(x1[[2]]/x2, xlim=c(0.5,5.5), at=1, ylim=c(0,1), main=x3)
  boxplot(x1[[3]]/x2, at=2, add=TRUE)
  boxplot(x1[[4]]/x2, at=3, add=TRUE)
  boxplot(x1[[5]]/x2, at=4, add=TRUE)
  boxplot(x1[[6]]/x2, at=5, add=TRUE)
  axis(1, at=1:5, labels=c("Annot.", "Unmapped", "Multim.", "Ambi.", "Unannot."))  
}

createBoxplots(bosMappingStats, bosMappingStats.sum, "Bos taurus")
#createBoxplots(capraMappingStats, capraMappingStats.sum, "Capra hircus")
createBoxplots(equusMappingStats, equusMappingStats.sum, "Equus caballus")
#createBoxplots(gallusMappingStats, gallusMappingStats.sum, "Gallus gallus")
#createBoxplots(ovisMappingStats, ovisMappingStats.sum, "Ovis aries")
createBoxplots(susMappingStats, susMappingStats.sum, "Sus scrofa")
```

# Expression analysis

## Expression values

We first import the expression values we got from featureCounts for the stringmerge output

```{r importExpressionValues}
getExpressions <- function(dir, lncRNA){
  sm.expressions <- fread(file.path(dir, "GTF", "Stringmerge_fc.csv"))
  colnames(sm.expressions) <- c(colnames(sm.expressions)[1:6],gsub(".bam", "", sapply(strsplit(colnames(sm.expressions)[-c(1:6)],".*/"),"[",2)))
  RPK <- sm.expressions[,7:ncol(sm.expressions)]
  RPK <- RPK/(sm.expressions$Length/1000)
  PMscaling <- apply(RPK,2,sum)/1000000
  TPM <- t(t(RPK) /PMscaling)

  FEELnc <- TPM[is.element(sm.expressions$Geneid,lncRNA),]
  
  out <- list(counts = sm.expressions,
              TPM = TPM,
              RPK = RPK,
              FEELnc = FEELnc,
              PMscaling = PMscaling)
  out
}


bosExpressions <- getExpressions(bosFolder, bosLNCIDs)
#capraExpressions <- getExpressions(capraFolder, capraLNCIDs)
equusExpressions <- getExpressions(equusFolder, equusLNCIDs)
#gallusExpressions <- getExpressions(gallusFolder, gallusLNCIDs)
#ovisExpressions <- getExpressions(ovisFolder, ovisLNCIDs)
susExpressions <- getExpressions(susFolder, susLNCIDs)
```

## Principle Component Analysis

```{r pca}
plotPCA <- function(x, data, main){
  if(data == "TPM"){
    dataToUse <- x$TPM
  } else if(data == "FEELnc"){
    dataToUse <- x$FEELnc
  } else {
    stop("No such data!!!")
  }
  d.pca <- prcomp(dataToUse, center=TRUE, scale=TRUE)
  
  pairs(d.pca$x[,1:5], main=paste("PCA", data , main))
}

plotPCA(bosExpressions, "FEELnc", "Bos taurus")
#plotPCA(capraExpressions, "FEELnc", "Capra hircus")
plotPCA(equusExpressions, "FEELnc", "Equus caballus")
#plotPCA(gallusExpressions, "FEELnc", "Gallus gallus")
#plotPCA(ovisExpressions, "FEELnc", "Ovis aries")
plotPCA(susExpressions, "FEELnc", "Sus scrofa")
```

## t-SNE

Now try t-SNE

```{r tsne}
plotTSNE <- function(x, data, main){
    if(data == "TPM"){
    dataToUse <- x$TPM
  } else if(data == "FEELnc"){
    dataToUse <- x$FEELnc
  } else {
    stop("No such data!!!")
  }

  set.seed(9)  

  tsne_model_1 <-  Rtsne(as.matrix(t(dataToUse)), check_duplicates=FALSE, perplexity=10, pca=TRUE, theta=0.5, dims=2)

  ## getting the two dimension matrix
  d_tsne_1 <- as.data.frame(tsne_model_1$Y)  

  plot(d_tsne_1, main=paste("t-SNE", data, main))
}

plotTSNE(bosExpressions, "FEELnc", "Bos taurus")
#plotTSNE(capraExpressions, "FEELnc", "Capra hircus")
plotTSNE(equusExpressions, "FEELnc", "Equus caballus")
#plotTSNE(gallusExpressions, "FEELnc", "Gallus gallus")
#plotTSNE(ovisExpressions, "FEELnc", "Ovis aries")
plotTSNE(susExpressions, "FEELnc", "Sus scrofa")
```